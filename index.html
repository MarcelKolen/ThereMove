<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.61/Tone.js"></script>
    <title>ThereMove</title>
</head>
<body>
<!-- page navigation header -->
<header>
    <nav class="navbar navbar-expand-lg navbar-light sticky-top" style="background-color: aquamarine;">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <div class="nav navbar-nav mr-auto" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active" style="color: slategray;" id="nav-STM-tab" data-toggle="tab"
                   href="#nav-STM" role="tab" aria-controls="nav-STM" aria-selected="true">Slider to Sound</a>
                <a class="nav-item nav-link" style="color: slategray;" id="nav-MTM-tab" data-toggle="tab"
                   href="#nav-MTM" role="tab" aria-controls="nav-MTM" aria-selected="false">Movement to Sound</a>
                <a class="nav-item nav-link" style="color: slategray;" id="nav-MTD-tab" data-toggle="tab"
                   href="#nav-MTD" role="tab" aria-controls="nav-MTD" aria-selected="false">Movement to Data</a>
            </div>
        </div>
    </nav>
</header>

<main>
    <div class="container" style="margin-top: 20px">
        <div class="row">
            <div class="col-md-12">
                <div class="tab-content" id="nav-tabContent">

                    <div class="tab-pane fade show active" id="nav-STM" role="tabpanel" aria-labelledby="nav-STM-tab">
                        <div class="jumbotron">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="pitch-min">Pitch-minimum</label>
                                                <input type="number" class="form-control" id="pitch-min" value="0"
                                                       min="0">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="pitch-max">Pitch-maximum</label>
                                                <input type="number" class="form-control" id="pitch-max" value="100"
                                                       min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="volume-range">Volume-range</label>
                                                <input type="range" class="form-control-range" id="volume-range"
                                                       value="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="pitch-range">Pitch-range</label>
                                                <input type="range" class="form-control-range" id="pitch-range"
                                                       value="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="volume-result">Volume</label>
                                                <input type="text" class="form-control" id="volume-result" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="pitch-result">Pitch</label>
                                                <input type="text" class="form-control" id="pitch-result" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="slider-music">
                                                <label class="custom-control-label" for="slider-music">Sound
                                                    on/off</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="nav-MTM" role="tabpanel" aria-labelledby="nav-MTM-tab">
                        <div class="jumbotron">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="pitch-min-MTM">Pitch-minimum</label>
                                                <input type="number" class="form-control" id="pitch-min-MTM" value="0"
                                                       min="0">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="pitch-max-MTM">Pitch-maximum</label>
                                                <input type="number" class="form-control" id="pitch-max-MTM" value="100"
                                                       min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="x-MTM">Accel-x</label>
                                                <input type="text" class="form-control" id="x-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="y-MTM">Accel-y</label>
                                                <input type="text" class="form-control" id="y-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="d-MTM">Datapoints</label>
                                                <input type="text" class="form-control" id="d-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="i-MTM">Interval</label>
                                                <input type="text" class="form-control" id="i-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="volume-result-MTM">Volume</label>
                                                <input type="text" class="form-control" id="volume-result-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="pitch-result-MTM">Pitch</label>
                                                <input type="text" class="form-control" id="pitch-result-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="px-MTM">Position x</label>
                                                <input type="text" class="form-control" id="px-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="py-MTM">Position y</label>
                                                <input type="text" class="form-control" id="py-MTM" value="0"
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input"
                                                       id="slider-music-MTM">
                                                <label class="custom-control-label" for="slider-music-MTM">Sound
                                                    on/off</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="nav-MTD" role="tabpanel" aria-labelledby="nav-MTD-tab">Movement to
                        Data
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="on-startup-modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">ThereMove</h5>
                </div>
                <div class="modal-body">
                    <p>In this demo we will show three components of our research into the simulation of a theremin
                        device:</p>
                    <p>
                    <ul>
                        <li>
                            Mapping raw numerical data to a synthesiser.
                        </li>
                        <li>
                            Converting movement data from the accelerometer into positional data and mapping it into the
                            synthesiser.
                        </li>
                        <li>
                            Showing the difficulties involved with working on accelerometer data through raw data
                            plotting.
                        </li>
                    </ul>
                    </p>
                    <p>Please refer to the <code>top menu bar</code> to switch between the different modes. Please also
                        note that every page has an <code>help me</code> button for a small guide into the app.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success btn-sm" id="start-app" data-dismiss="modal">Click on me
                        to start the app
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

</body>
</html>
<script>
    const volumeMax = 10;
    const volumeMin = 0;
    var volumeRange = 100;
    var volumeActual = 10;

    var pitchMax = 500;
    var pitchMin = 0;
    var pitchRange = 0;
    var pitchActual = 0;

    const synth = new Tone.Synth().toDestination();
    const now = Tone.now()

    var soundEnabled = false;
    var soundRunning = false;

    /* Setup page data */

    $(document).ready(function () {
        $("#on-startup-modal").modal();

        $("#volume-range").val(volumeRange);
        $("#volume-result").val(volumeActual);

        $("#pitch-min").val(pitchMin);
        $("#pitch-max").val(pitchMax);
        $("#pitch-range").val(pitchRange);
        $("#pitch-result").val(pitchActual + " Hz");
        $("#d-MTM").val(datapoints);
    })

    $("#nav-MTM-tab").on("click", function (e) {
        $("#slider-music").prop('checked', false);
        sliderPage();
    })

    /* Sound running functions */

    function updateVolumeActual(volumeRange, volumeRangeSize=100) {
        volumeActual = Math.round(volumeMin + ((volumeMax - volumeMin) * (volumeRange / volumeRangeSize)));
        $("#volume-result").val(volumeActual);

        if (soundEnabled) {
            if (volumeActual === 0) {
                if (soundRunning) {
                    synth.triggerRelease(now);
                    soundRunning = false;
                }
            } else {
                if (soundRunning)
                    synth.volume.rampTo(volumeActual, 0.1);
                else {
                    synth.triggerAttack(pitchActual, now);
                    soundRunning = true;
                }
            }
        }
    }

    function updatePitchActual(pitchRange, pitchRangeSize=100) {
        pitchActual = Math.round(pitchMin + ((pitchMax - pitchMin) * (pitchRange / pitchRangeSize)));
        $("#pitch-result").val(pitchActual + " Hz");

        if (soundEnabled) {
            synth.frequency.rampTo(pitchActual, 0.1);
        }
    }

    /* MOTION TO SOUND */

    var a_x;
    var a_y;
    var a_i;
    var datapoints = 0;

    var v_x = 0;
    var p_x = 0;

    var v_y = 0;
    var p_y = 0;

    function motionHandler(event) {
        a_x = event.acceleration.x;
        a_y = event.acceleration.y;
        a_i = event.interval;

        v_x = v_x + a_x * a_i;
        v_y = v_y + a_y * a_i;
        p_x = p_x + v_x * a_i;
        p_y = p_y + v_y * a_i;

        if (p_x < 0)
            p_x = 0;
        else if (p_x > 10)
            p_x = 10;

        updatePitchActual(p_x, 10);

        if (p_y < 0)
            p_y = 0;
        else if (p_y > 10)
            p_y = 10;

        updateVolumeActual(p_y, 10);

        $("#x-MTM").val(a_x + " ms2");
        $("#y-MTM").val(a_y + " ms2");
        $("#i-MTM").val(a_i + " ms2");
        $("#px-MTM").val(p_x);
        $("#py-MTM").val(p_y);

        datapoints += 1;
        $("#d-MTM").val(datapoints);
    }

    accessRequestFault = false;

    $("#slider-music-MTM").click(function (e) {
        if (!accessRequestFault && typeof( DeviceMotionEvent ) !== "undefined" && typeof( DeviceMotionEvent.requestPermission ) === "function") {
            DeviceMotionEvent.requestPermission().then( response => {
                // (optional) Do something after API prompt dismissed.
                if ( response !== "granted" ) {
                    alert("Warning: Your device has either blocked access to your movement devices or does not have them.");
                    alert("This application requires data from the accelerometer to function correctly.");
                    accessRequestFault = true;
                }
            })
        }

        if ($("#slider-music-MTM").prop("checked")) {
            window.addEventListener("devicemotion", motionHandler);
            if (volumeActual > 0)
                soundRunning = true
            if (soundRunning) {
                synth.triggerAttack(pitchActual, now);
                synth.volume.rampTo(volumeActual, 0.1);
            }
            soundEnabled = true;
        } else {
            window.removeEventListener("devicemotion", motionHandler);
            synth.triggerRelease(now);
            soundEnabled = false;
            soundRunning = false;
        }
    })

    /* SLIDER */

    /* Data fetching from the slider section */

    $(document).on("input", '#volume-range', function () {
        volumeRange = $(this).val();
        updateVolumeActual(volumeRange, 100);
    });

    $(document).on("input", '#pitch-range', function () {
        pitchRange = $(this).val();
        updatePitchActual(pitchRange, 100);
    });

    $(document).on("input", '#pitch-min', function () {
        pitchMin = parseInt($(this).val());
        updatePitchActual();
    });

    $(document).on("input", '#pitch-max', function () {
        pitchMax = parseInt($(this).val());
        updatePitchActual();
    });

    /* Slider run function */

    function sliderPage() {
        if ($("#slider-music").prop("checked")) {
            if (volumeActual > 0)
                soundRunning = true
            if (soundRunning) {
                synth.triggerAttack(pitchActual, now);
                synth.volume.rampTo(volumeActual, 0.1);
            }
            soundEnabled = true;
        } else {
            synth.triggerRelease(now);
            soundEnabled = false;
            soundRunning = false;
        }
    }

    /* Start slider page */

    $("#start-app").click(function (e) {
        Tone.start();

        $("#slider-music").click(function (e) {
            sliderPage();
        })
    })
</script>